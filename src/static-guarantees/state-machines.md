<!-- # Peripherals as State Machines -->

# ステートマシンとしてのペリフェラル

<!--
The peripherals of a microcontroller can be thought of as set of state machines. For example, the configuration of a simplified [GPIO pin] could be represented as the following tree of states:
-->

マイクロコントローラのペリフェラルは、一連のステートマシンとして考えることができます。
例えば、簡略化された[GPIOピン]の設定は、次の状態ツリーとして表すことができます。

<!-- [GPIO pin]: https://en.wikipedia.org/wiki/General-purpose_input/output -->

[GPIOピン]: https://en.wikipedia.org/wiki/General-purpose_input/output

<!--
* Disabled
* Enabled
    * Configured as Output
        * Output: High
        * Output: Low
    * Configured as Input
        * Input: High Resistance
        * Input: Pulled Low
        * Input: Pulled High
-->

* 無効
* 有効
    * 出力として設定
        * 出力：ハイ
        * 出力：ロー
    * 入力として設定
        * 入力：高抵抗（訳注：ハイインピーダンス）
        * 入力：プルダウン
        * 入力：プルアップ

<!-- If the peripheral starts in the `Disabled` mode, to move to the `Input: High Resistance` mode, we must perform the following steps: -->

このペリフェラルが`無効`モードから始まるとすると、`入力：高抵抗`モードに移行するには、次のステップを踏みます。

<!--
1. Disabled
2. Enabled
3. Configured as Input
4. Input: High Resistance
-->

1. 無効
2. 有効
3. 入力として設定
4. 入力：高抵抗

<!-- If we wanted to move from `Input: High Resistance` to `Input: Pulled Low`, we must perform the following steps: -->

`入力：高抵抗`から`入力：プルダウン`へと移る場合、次のステップを実行しなければなりません。

<!--
1. Input: High Resistance
2. Input: Pulled Low
-->

1. 入力：高抵抗
2. 入力：プルダウン

<!-- Similarly, if we want to move a GPIO pin from configured as `Input: Pulled Low` to `Output: High`, we must perform the following steps: -->

同じように、`入力：プルダウン`と設定されているGPIOピンを、`出力：ハイ`にするには、次のステップを実行しなければなりません。

<!--
1. Input: Pulled Low
2. Configured as Input
3. Configured as Output
4. Output: High
-->

1. 入力：プルダウン
2. 入力として設定
3. 出力として設定
4. 出力：ハイ

<!-- ## Hardware Representation -->

## ハードウェアの表現

<!--
Typically the states listed above are set by writing values to given registers mapped to a GPIO peripheral. Let's define an imaginary GPIO Configuration Register to illustrate this:
-->

通常、上記の状態は、GPIOペリフェラルに割り当てられたレジスタに値を書き込むことで設定できます。
これを説明するために、架空のGPIO設定レジスタを定義しましょう。

<!--
| Name         | Bit Number(s) | Value | Meaning   | Notes |
| ---:         | ------------: | ----: | ------:   | ----: |
| enable       | 0             | 0     | disabled  | Disables the GPIO |
|              |               | 1     | enabled   | Enables the GPIO |
| direction    | 1             | 0     | input     | Sets the direction to Input |
|              |               | 1     | output    | Sets the direction to Output |
| input_mode   | 2..3          | 00    | hi-z      | Sets the input as high resistance |
|              |               | 01    | pull-low  | Input pin is pulled low |
|              |               | 10    | pull-high | Input pin is pulled high |
|              |               | 11    | n/a       | Invalid state. Do not set |
| output_mode  | 4             | 0     | set-low   | Output pin is driven low |
|              |               | 1     | set-high  | Output pin is driven high |
| input_status | 5             | x     | in-val    | 0 if input is < 1.5v, 1 if input >= 1.5v |
-->

| 名前          | ビットフィールド | 値    | 意味      | 説明 |
| ---:         | ------------: | ----: | ------:   | ----: |
| 有効          | 0             | 0     | 無効       | GPIOを無効にする |
|              |               | 1     | 有効       | GPIOを有効にする |
| 方向          | 1             | 0     | 入力       | 方向を入力に設定する |
|              |               | 1     | 出力       | 方向を出力に設定する |
| 入力モード     | 2..3          | 00    | hi-z      | 入力を高抵抗に設定する |
|              |               | 01    | プルダウン  | 入力ピンはプルダウンになる |
|              |               | 10    | プルアップ  | 入力ピンはプルアップになる |
|              |               | 11    | n/a       | 無効な状態。設定しないこと。 |
| 出力モード     | 4             | 0     | ロー      | 出力ピンをローにする |
|              |               | 1     | ハイ      | 出力ピンをハイにする |
| 入力状態      | 5             | x     | 入力値     | 入力が1.5Vより低ければ0、1.5V以上であれば1 |

<!-- We _could_ expose the following structure in Rust to control this GPIO: -->

このGPIOを制御するために、次のようなRustの構造体を公開することが _できます_。

```rust,ignore
# /// GPIO interface
/// GPIOインタフェース
struct GpioConfig {
#     /// GPIO Configuration structure generated by svd2rust
    /// svd2rustで生成されたGPIO設定構造体
    periph: GPIO_CONFIG,
}

impl Gpio {
    pub fn set_enable(&mut self, is_enabled: bool) {
        self.periph.modify(|_r, w| {
            w.enable().set_bit(is_enabled)
        });
    }

    pub fn set_direction(&mut self, is_output: bool) {
        self.periph.modify(|r, w| {
            w.direction().set_bit(is_output)
        });
    }

    pub fn set_input_mode(&mut self, variant: InputMode) {
        self.periph.modify(|_r, w| {
            w.input_mode().variant(variant)
        });
    }

    pub fn set_output_mode(&mut self, is_high: bool) {
        self.periph.modify(|_r, w| {
            w.output_mode.set_bit(is_high)
        });
    }

    pub fn get_input_status(&self) -> bool {
        self.periph.read().input_status().bit_is_set()
    }
}
```

<!--
However, this would allow us to modify certain registers that do not make sense. For example, what happens if we set the `output_mode` field when our GPIO is configured as an input? 
-->

しかし、この実装では、筋が通らないレジスタの修正が可能になってしまいます。例えば、GPIOを入力に設定している時に、`出力モード`を設定すると、どうなるのでしょう？

<!--
In general, use of this structure would allow us to reach states not defined by our state machine above: e.g. an output that is pulled low, or an input that is set high. For some hardware, this may not matter. On other hardware, it could cause unexpected or undefined behavior!
-->

通常、この構造体を利用すると、上のステートマシンで定義されていない状態に到達できてしまいます。
例えば、プルダウンの出力や、ハイに設定された入力、です。

<!-- Although this interface is convenient to write, it doesn't enforce the design contracts set out by our hardware implementation. -->

このインタフェースは書き込みには便利ですが、ハードウェア実装によって定められた設計の契約を強制しません。